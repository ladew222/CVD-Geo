<!DOCTYPE html>
<html>
<head>
	<head>
		<title>Bootstrap Example</title>
		<meta charset="utf-8">
    <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
        <script src="pearson-correlation.js"></script>
      <script src="statistics.min.js" type="text/javascript"></script>


 		<!--<script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script> -->
 		<!--<link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/themes/smoothness/jquery-ui.min.css" /> -->
		<link rel="stylesheet" href="main.css">

	</head>
	<title></title>
</head>

<body>
<script src="//d3plus.org/js/d3.min.js"></script>
<!-- D3.js -->
<script src="https://d3plus.org/js/d3plus.v2.0.0-alpha.25.full.min.js"></script>

<script type="text/javascript">

  const config_new = {
  groupBy: "id",
  label: function(d) {
           var text = "<b class='p-head'>"+ d.County + "</b><span class='p-other'></br>Confirmed: " + d.Confirmed + "</br>Per10K: " + d.ConfirmedPer10K + "</br> Deaths: " + d.Death + "<BR/>Population: "+ d.TotalPop + "</br>Gini Index: " + d.IncomeIneq + "</BR>Asia born 10k: "+ d.AsiaPop10k +"</br>Europe Born 10k:  " +d.EuropePop10k + "</br>No Insur 35-64 10k: " + d.insured35to64_per10k + "</span>" ;
            return "" + text;
        },
  ocean: "transparent",
  projection: "geoAlbersUsa",
  topojson: "https://d3plus.org/topojson/counties.json",
  type: "Geomap"
};

  let itemList=[];
  let curr_day="14"
  let curr_month="3"
  let days=0;
  let index=0;
  let range=0;
  let type = "Confirmed"
  let selected_day =0;
  let selected_state = 0;
  const map = new d3plus.Geomap()
  .config(config_new)
  .data(itemList[0])
  .colorScale("Confirmed");




 $(document).ready(function(){
    map
    .select('#viz')
    .render();

    $('#days').on('click', 'a.days', function() {
        click_day = parseInt($(this).data( "day" ));
        const primary_var = $("input[name='my_options']:checked").val();
        const test_arr =[0,range];

        selected_day = click_day;
         map
           .data(itemList[click_day])
           .fitFilter(function(d) {
               const state = d.id.split('US')[1].substring(0, 2);
               if( selected_state!=0  ){
                   return [ selected_state].indexOf(state)<0;
               }
               else{
                   return true;
               }
             })
           .colorScaleConfig({axisConfig: {
               domain: test_arr
             }})

          .render();
    });


   var handle = $( "#custom-handle" );
   $( "#slider" ).slider({
     create: function() {
       handle.text( $( this ).slider( "value" ) );
     },
     slide: function( event, ui ) {
       range=ui.value;
       handle.text( ui.value );
     }
   });


    $( "#slider-range" ).slider({
      range: true,
      min: new Date('2020.03.14').getTime() / 1000,
      max: new Date().getTime() / 1000,
      step: 86400,
      values: [ new Date('2020.03.14').getTime() / 1000, new Date('2020.03.14').getTime() / 1000 ],
      slide: function( event, ui ) {
        const start_date = new Date(ui.values[ 0 ] *1000);
        const end_date= new Date(ui.values[ 1 ] *1000);
        const start_month = start_date.getUTCMonth() + 1; //months from 1-12
        const start_day = start_date.getUTCDate(); + 1; //months from 1-12

        curr_day = start_day; 
        curr_month = start_month;
        const diffTime = Math.abs(start_date - end_date);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
        days= diffDays;
         $( "#amount" ).val( (new Date(ui.values[ 0 ] *1000).toDateString() ) + " - " + end_date.toDateString() );
      } 
    });

    $( "#amount" ).val( (new Date($( "#slider-range" ).slider( "values", 0 )*1000).toDateString()) +
      " - " + (new Date($( "#slider-range" ).slider( "values", 1 )*1000)).toDateString());


$("#test").button().click(function(){
    $( "#corr-res" ).html(corr_test(selected_day));

});

        //    button click
    $("#btnSubmit").button().click(function(){
      //$('#viz').empty();
        for (i = 0; i < days; i++) {
            get_data(i);
            day_now = parseInt(curr_day)+i;
            $("#days").append("<a class='days' data-day='" + i +  "'  href='#'>View "+ curr_month + "/" + day_now +  "</a></br>");
        }
    });  

    $('#my_radio_box').change(function(){
        type= $("input[name='my_options']:checked").val();        

    });

 });

  d3.csv("us-state-fips.csv", function(error, data) {
      var select = d3.select("#states")
          .append("div")
          .append("select")

      select
          .on("change", function(d) {
              selected_state = d3.select(this).property("value");
          });

      select.selectAll("option")
          .data(data)
          .enter()
          .append("option")
          .attr("value", function (d) { return d.st; })
          .text(function (d) { return d.stname; });
  });

  ////test


 ////test


const config = {
  groupBy: "ID State",
  label: function(d) {
      var text = d.County + "</br>Confirmed: " + d.Confirmed + "</br>Per10K: " + d.ConfirmedPer10K + "</br> Deaths: " + d.Death + "<BR/>Population: "+ d.TotalPop + "</br>Gini Index: " + d.IncomeIneq + "</BR>Asia born 10k: "+ d.AsiaPop10k +"</br>Europe Born 10k:  " +d.EuropePop10k + "</br>UnInsured 35to64 10k: " + d.insured35to64_per10k ;
  },
  ocean: "transparent",
  projection: "geoAlbersUsa",
  topojson: "https://d3plus.org/topojson/states.json",
  /*time: d => d.Year || d["End Year"],*/
  type: "Geomap"
};


/////end jquery

function corr_test(the_day){
    let testArr=["IncomeIneq","EuropePop10k","AsiaPop10k","insured35to64_per10k","white10k","med_age"];

    let out_str="<div class='corr-rs'>";
    testArr.forEach(function(number, i) {
        let val = testArr[i];
        let Confirmed= null;
        let val1 = null
        if (selected_state !=0){
            Confirmed = itemList[the_day].filter(function(obj) {
                return parseInt(obj.state)==parseInt(selected_state);
            }).map(function(obj) { return obj[val]; });

            val1 = itemList[the_day].filter(function(obj) {
                return parseInt(obj.state)==parseInt(selected_state);
            }).map(function(obj) { return obj.Confirmed; });

        }
        else{
            Confirmed = itemList[0].map(a => a.Confirmed);
            val1 = itemList[the_day].map(a => a[val]);

        }
        const Confirmed_int = Confirmed.map(Number);
        const val1_int = val1.map(Number);

        const result = (Math.round(pearson(val1_int,Confirmed_int) * 100) / 100).toFixed(2);
        out_str+= val + ": " + result + " </br>";
    });
    out_str+="</div>";

    return out_str

}



function get_data(day_num){
    itemList[day_num] = [];
    //curr_day
    d3.csv("county_fips_revised.csv", function(fipsData) {
    let the_day = parseInt(curr_day)+day_num;
    const formattedDay = ("0" + the_day).slice(-2);
    const formattedMonth = ("0" + curr_month).slice(-2);
    d3.csv("https://raw.githubusercontent.com/tomquisel/covid19-data/master/data/csv/" + "2020-" + formattedMonth + "-" + formattedDay + ".csv" , function(cvData) {
      cvData.forEach(function(cvItem) {    ///new RegExp('/contact\\b', 'g').test(href)
        //const regexp = new RegExp(cvItem.county_name, 'i');
        const result = fipsData.filter(fipsItem => fipsItem.State== cvItem.State_Name  && new RegExp(cvItem.County_Name, 'i').test(fipsItem.County));
        if (result[0]){
          result[0].id = "05000US"+ result[0].fips;
          //AsiaPop10k <- ((acs_Data$JWOE047/acs_Data$JWAE001)*10000)
          Object.assign(result[0],cvItem);  
          result[0].ConfirmedPer10K=Number((Math.round(((result[0].Confirmed/result[0].TotalPop)*10000) * 100) / 100).toFixed(3));
          itemList[day_num].push(result[0]);
        }
        else{
          console.log(cvItem.County_Name + " " + cvItem.State_Name + " Not Found");
        }
        console.log("done");
         
      });
      //alert("done"+ + "2020-" + formattedMonth + "-" + formattedDay + ".csv")
    });
  });

}







</script>


<div class="container">
    <section class="pt-5 pb-5 ">
        <div class="container">
            <div class="row">
                <div class="col-md-12 text-center">
                    <h1 class="mt-0 mb-3 title">COVID Data Explorer</h1>
                    <div class="breadcrumbs">
                    </div>
                </div>
            </div>
        </div>
    </section>
  <div class="row">
  	<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
    
    </div>
    <div class="col-sm-3 col-md-6 col-lg-3" style="background-color:silver;padding-bottom:60px">
      <div id="header"></div>

      <p>
      <label for="amount">Date range:</label>
        <input type="text" id="amount" style="border: 0;padding-left: 8px; color: #f6931f;border: 1px solid; font-weight: bold;" size="30"/>
      </p>
      <div id="slider-range"></div> 
    </br>
        <input id = "btnSubmit" type="submit" value="Get Data"/>
      </br>
        </br>
        </br>
        <B>Color Variable</B>
      <form id="my_radio_box">
        <div class="form-check">
          <input class="form-check-input" name="my_options" type="radio" name="exampleRadios" id="exampleRadios1" value="Confirmed" checked>
          <label class="form-check-label" for="exampleRadios1">
            Confirmed
          </label>
        </div>
        <div class="form-check">
          <input class="form-check-input" name="my_options" type="radio" name="exampleRadios" id="exampleRadios2" value="ConfirmedPer10K" >
          <label class="form-check-label" for="exampleRadios2">
            Confirmed per 10K
          </label>
        </div>
        <div class="form-check disabled">
          <input class="form-check-input" name="my_options" type="radio" name="exampleRadios" id="exampleRadios3" value="Death" >
          <label class="form-check-label" for="exampleRadios3">
            Fatalities
          </label>
        </div>
      </form>
        <div id="days">


        </div>
      <h5>Scale Max</h5>
      <div id="slider">
        <div id="custom-handle" class="ui-slider-handle"></div>
      </div>
        <p>
            <div id="states">

            </div>

        </p>
        <input id = "test" type="submit" value="Correlation Test"/>

        <div id="corr-res">

        </div>

    </div>
    <div class="col-sm-0 col-md-6 col-lg-9" >
      <div id="container">
    	 <div id="viz" style="height: 600px"></div>
      </div>
    </div>
  </div>
</div>
</body>
</html>